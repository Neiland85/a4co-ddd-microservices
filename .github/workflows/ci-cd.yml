name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  deployments: write
  id-token: write

env:
  REGISTRY: ghcr.io
  NODE_VERSION: '22'
  PNPM_VERSION: '10.14.0'

jobs:
  # ===========================================
  # Lint & Format Checks
  # ===========================================
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ‚öôÔ∏è Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: üì¶ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üßπ Run ESLint
        run: pnpm run lint

      - name: üé® Check Prettier formatting
        run: pnpm exec prettier --check "**/*.{ts,tsx,js,jsx,json,md,yaml,yml}" --ignore-path .prettierignore

  # ===========================================
  # Unit Tests with Coverage
  # ===========================================
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint-format]

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ‚öôÔ∏è Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: üì¶ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üß™ Run tests with coverage
        run: pnpm run test -- --coverage --passWithNoTests
        env:
          CI: true

      - name: üìä Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            **/coverage/
          retention-days: 7

  # ===========================================
  # Build & Push Docker Images
  # ===========================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    strategy:
      fail-fast: true
      matrix:
        service:
          - name: order-service
            context: ./apps/order-service
            dockerfile: ./apps/order-service/Dockerfile
            target: prod
          - name: payment-service
            context: ./apps/payment-service
            dockerfile: ./apps/payment-service/Dockerfile
            target: prod
          - name: inventory-service
            context: ./apps/inventory-service
            dockerfile: ./apps/inventory-service/Dockerfile
            target: prod
          - name: gateway
            context: ./apps/gateway
            dockerfile: ./apps/gateway/Dockerfile
            target: prod
          - name: frontend
            context: ./apps/frontend
            dockerfile: ./apps/frontend/Dockerfile
            target: prod

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service.name }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: üèóÔ∏è Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            org.opencontainers.image.title=${{ matrix.service.name }}
            org.opencontainers.image.description=A4CO ${{ matrix.service.name }} microservice
            prometheus.io/scrape=true
            prometheus.io/port=3000
            prometheus.io/path=/metrics
            a4co.region=andalucia
            a4co.service=${{ matrix.service.name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: ${{ matrix.service.target }}
          build-args: |
            SERVICE_NAME=${{ matrix.service.name }}
            REGION=andalucia

  # ===========================================
  # Deploy to Development Environment
  # ===========================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-images]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.ref != 'refs/heads/main')
    environment:
      name: development
      url: https://dev.a4co.andalucia.es

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to development
        run: |
          echo "üöÄ Deploying to development environment"
          echo "üì¶ Images deployed:"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository }}/order-service:${{ github.sha }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository }}/payment-service:${{ github.sha }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository }}/inventory-service:${{ github.sha }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository }}/gateway:${{ github.sha }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository }}/frontend:${{ github.sha }}"
          echo ""
          echo "üè∑Ô∏è Prometheus labels configured:"
          echo "  - region: andalucia"
          echo "  - service: <service-name>"
          echo ""
          echo "‚è∞ Deployed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"

      - name: üìä Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ Development Deployment Summary

          | Service | Image Tag | Status |
          |---------|-----------|--------|
          | order-service | `${{ github.sha }}` | ‚úÖ Deployed |
          | payment-service | `${{ github.sha }}` | ‚úÖ Deployed |
          | inventory-service | `${{ github.sha }}` | ‚úÖ Deployed |
          | gateway | `${{ github.sha }}` | ‚úÖ Deployed |
          | frontend | `${{ github.sha }}` | ‚úÖ Deployed |

          ### Prometheus Labels
          - `region="andalucia"`
          - `service="<service-name>"`

          ### Deployment Details
          - **Environment:** Development
          - **Commit:** `${{ github.sha }}`
          - **Actor:** @${{ github.actor }}
          - **Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

  # ===========================================
  # Production Build Summary
  # ===========================================
  production-ready:
    name: Production Ready Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-images]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ‚úÖ Production ready summary
        run: |
          echo "‚úÖ All checks passed!"
          echo "üì¶ Docker images built and pushed to GHCR"
          echo "üè∑Ô∏è Tags: ${{ github.sha }}, main, latest"
          echo ""
          echo "üîí Ready for production deployment"

      - name: üìä Create production summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ‚úÖ Production Ready

          All CI/CD checks have passed. Docker images are built and pushed to GHCR.

          ### Available Tags
          - `${{ github.sha }}` (commit SHA)
          - `main` (branch name)
          - `latest`

          ### Next Steps
          Deploy to production using the `deploy-production.yml` workflow or trigger manually.
          EOF
