name: Lint sensitive versions

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "pnpm-lock.yaml"
      - "**/package.json"
  push:
    branches:
      - main
      - copilot/fix-dependabot-alerts-nextjs

jobs:
  guard-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Next.js and qs minimum versions
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const MIN = { next: '15.5.9', qs: '6.14.1' };
          const ALERT = ` Seguridad: Se detect贸 una regresi贸n de versi贸n en 'next' o 'qs'.\nPor favor, mant茅n la versi贸n m铆nima segura:\n- next >= ${MIN.next}\n- qs >= ${MIN.qs}`;
          const errors = [];

          const cmp = (a, b) => {
            const pa = a.split('.').map(Number);
            const pb = b.split('.').map(Number);
            for (let i = 0; i < 3; i += 1) {
              const diff = (pa[i] || 0) - (pb[i] || 0);
              if (diff !== 0) return diff;
            }
            return 0;
          };

          const extractVersion = (spec) => {
            if (!spec || typeof spec !== 'string') return null;
            const match = spec.match(/(\\d+\\.\\d+\\.\\d+)/);
            return match ? match[1] : null;
          };

          const checkMap = (map, source) => {
            if (!map) return;
            for (const [pkg, min] of Object.entries(MIN)) {
              const version = extractVersion(map[pkg]);
              if (version && cmp(version, min) < 0) {
                errors.push(`${pkg} ${version} in ${source} is below ${min}`);
              }
            }
          };

          const checkPackageJson = (file) => {
            const data = JSON.parse(fs.readFileSync(file, 'utf8'));
            checkMap(data.dependencies, `${file} dependencies`);
            checkMap(data.devDependencies, `${file} devDependencies`);
            checkMap(data.pnpm?.overrides || data.overrides, `${file} overrides`);
          };

          const walk = (dir) => {
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              if (entry.name === 'node_modules' || entry.name === '.git') continue;
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) {
                walk(full);
              } else if (entry.isFile() && entry.name === 'package.json') {
                checkPackageJson(full);
              }
            }
          };

          walk(process.cwd());

          const lockPath = path.join(process.cwd(), 'pnpm-lock.yaml');
          if (fs.existsSync(lockPath)) {
            const content = fs.readFileSync(lockPath, 'utf8');
            for (const [pkg, min] of Object.entries(MIN)) {
              const versions = Array.from(content.matchAll(new RegExp(`${pkg}@(\\d+\\.\\d+\\.\\d+)`, 'g'))).map(m => m[1]);
              for (const v of versions) {
                if (cmp(v, min) < 0) {
                  errors.push(`${pkg} ${v} in pnpm-lock.yaml is below ${min}`);
                }
              }
              if (versions.length === 0) {
                errors.push(`${pkg} not found in pnpm-lock.yaml`);
              }
            }
          } else {
            errors.push('pnpm-lock.yaml is missing');
          }

          if (errors.length) {
            console.error(ALERT);
            for (const err of errors) console.error(`- ${err}`);
            process.exit(1);
          } else {
            console.log('Version guard passed: next and qs meet minimum requirements.');
          }
          NODE
