name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

jobs:
  # =============================================================
  # BUILD + LINT + TYPECHECK (DENTRO DEL CONTENEDOR)
  # =============================================================
  build_and_analyze:
    name: Build & Quality Check
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # Fix cr√≠tico: instalar tar ANTES de checkout
      # ---------------------------------------------------------
      - name: Ensure tar is available before checkout
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar
          tar --version

      # ---------------------------------------------------------
      # Checkout repo
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Ejecutar TODO dentro del contenedor Alpine
      # ---------------------------------------------------------
      - name: Run build tasks inside container
        uses: addnab/docker-run-action@v3
        with:
          image: node:22-alpine
          options: -v ${{ github.workspace }}:/workspace -w /workspace
          run: |
            echo "Node version inside container:"
            node -v

            # Habilitar corepack
            corepack enable

            # Instalar pnpm DENTRO del contenedor
            echo "Installing pnpm inside container..."
            npm install -g pnpm@10.14.0

            pnpm --version

            # Instalar dependencias
            pnpm install --no-frozen-lockfile || true

            # Prisma
            pnpm -w exec prisma generate || true

            # Lint
            pnpm -w run lint || echo "Lint warnings"

            # Type-check
            pnpm -w run type-check || echo "TS warnings"

            # Build all except auth-service
            pnpm -r --ignore @a4co/auth-service run build || echo "Build warnings"


  # =============================================================
  # DEPLOY AUTH SERVICE A VERCEL
  # =============================================================
  deploy_auth_service:
    name: Deploy Auth Service
    needs: [build_and_analyze]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0
          run_install: false

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Prisma generate
        run: pnpm -w exec prisma generate

      - name: Build Auth Service
        run: pnpm --filter @a4co/auth-service build

      - name: Deploy to Vercel
        run: |
          npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
