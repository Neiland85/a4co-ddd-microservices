name: CI

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - copilot/fix-dependabot-alerts-nextjs

jobs:
  security-verification:
    name: Security verification (Next.js & qs)
    runs-on: ubuntu-latest
    env:
      NEXT_FONT_DISABLE_HOSTED_DOWNLOADS: "1"
      NEXT_TELEMETRY_DISABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install

      - name: Verify Next.js and qs versions
        run: |
          pnpm why next
          pnpm why qs
          if ! pnpm why next | grep -q "15.5.9"; then
            echo "Expected Next.js 15.5.9 to be installed"
            exit 1
          fi
          if ! pnpm why qs | grep -Eq "6\\.14\\.1|6\\.1[5-9]\\.|7\\.|8\\.|9\\."; then
            echo "Expected qs >= 6.14.1 to be installed via override"
            exit 1
          fi

      - name: Build dashboard-client
        run: pnpm --filter dashboard-client build

      - name: Build design-system h-modern-dashboard
        run: pnpm --filter @a4co/v0-modern-dashboard build

      - name: Test dashboard-client (if present)
        run: pnpm --filter dashboard-client test --if-present

      - name: Test design-system h-modern-dashboard (if present)
        run: pnpm --filter @a4co/v0-modern-dashboard test --if-present
