name: CI

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  security-verification:
    name: Security verification (Next.js & qs)
    runs-on: ubuntu-latest
    env:
      NEXT_FONT_DISABLE_HOSTED_DOWNLOADS: "1"
      NEXT_TELEMETRY_DISABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Install pnpm
        run: corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install

      - name: Verify Next.js and qs versions
        run: |
          node <<'NODE'
          const { execSync } = require('node:child_process');

          const MIN = { next: '15.5.9', qs: '6.14.1' };

          const cmp = (a, b) => {
            const pa = a.split('.').map(Number);
            const pb = b.split('.').map(Number);
            for (let i = 0; i < 3; i += 1) {
              const diff = (pa[i] || 0) - (pb[i] || 0);
              if (diff !== 0) return diff;
            }
            return 0;
          };

          const check = (pkg) => {
            const output = execSync(`pnpm ls ${pkg} --depth -1 --json`, { encoding: 'utf8' });
            const info = JSON.parse(output)[0];
            const version = info?.dependencies?.[pkg]?.version;
            if (!version) {
              throw new Error(`Missing ${pkg} in dependency graph`);
            }
            if (cmp(version, MIN[pkg]) < 0) {
              throw new Error(`${pkg}@${version} is below ${MIN[pkg]}`);
            }
            console.log(`${pkg}@${version} verified (>= ${MIN[pkg]})`);
          };

          Object.keys(MIN).forEach(check);
          NODE

      - name: Build dashboard-client
        run: pnpm --filter dashboard-client build

      - name: Build design-system h-modern-dashboard
        run: pnpm --filter @a4co/v0-modern-dashboard build

      - name: Test dashboard-client (if present)
        run: pnpm --filter dashboard-client test --if-present

      - name: Test design-system h-modern-dashboard (if present)
        run: pnpm --filter @a4co/v0-modern-dashboard test --if-present
