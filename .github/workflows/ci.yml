name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

jobs:
  build_and_analyze:
    name: Build & Quality Check
    runs-on: ubuntu-latest

    steps:
      # =========================================================
      #  FIX CR√çTICO: instalar tar ANTES del checkout (host)
      # =========================================================
      - name: Ensure tar is available before checkout
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar
          tar --version

      # =========================================================
      #  Checkout del repo (YA sin errores)
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      #  Entramos en el contenedor (solo para los steps siguientes)
      # =========================================================
      - name: Start container
        uses: addnab/docker-run-action@v3
        with:
          image: node:22-alpine
          options: -v ${{ github.workspace }}:/workspace -w /workspace
          run: |
            echo "Container ready with Node $(node -v)"
            corepack enable

            # =====================================================
            #  Setup PNPM
            # =====================================================
            pnpm --version || npm install -g pnpm@10.14.0

            # =====================================================
            #  Install deps
            # =====================================================
            pnpm install --no-frozen-lockfile || true
            pnpm -w exec prisma generate || true

            # =====================================================
            #  Lint
            # =====================================================
            pnpm --filter "./packages/*" run lint || echo "Lint warning"

            # =====================================================
            #  Typecheck
            # =====================================================
            pnpm -w run type-check || echo "TS warnings"

            # =====================================================
            #  Build (except auth)
            # =====================================================
            pnpm -r --ignore @a4co/auth-service run build || echo "Build warnings"

  # =============================================================
  #  Deploy Auth a Vercel
  # =============================================================
  deploy_auth_service:
    name: Deploy Auth Service
    needs: [build_and_analyze]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - uses: pnpm/action-setup@v2
        with:
          version: "10.14.0"
          run_install: true

      - name: Build auth-service
        run: pnpm --filter @a4co/auth-service build || echo "Auth build warning"

      - name: Deploy to Vercel
        run: |
          npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

