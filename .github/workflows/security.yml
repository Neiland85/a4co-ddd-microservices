name: Security Scan

on:
  pull_request:
  push:
    branches:
      - main
      - develop
  schedule:
    # Ejecutar auditorÃ­a semanal los domingos a las 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: GitGuardian scan (full repository)
        uses: GitGuardian/ggshield-action@v1.1.0  # âœ… Usa versiÃ³n vÃ¡lida en lugar de @main
        with:
          args: scan --mode full

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Audit sensitive files
        run: |
          echo "ðŸ” Auditing sensitive files..."
          # Buscar archivos potencialmente sensibles
          find . -name "*.key" -o -name "*ssh*" -o -name "*private*" -o -name "*secret*" -o -name "*token*" -o -name "*password*" -o -name "*credential*" | grep -v node_modules | grep -v ".git" || echo "No sensitive files found"
          echo "âœ… Audit completed"

      - name: Check for hardcoded secrets in code
        run: |
          echo "ðŸ” Checking for hardcoded secrets in source code..."
          # Buscar patrones comunes de secrets hardcodeados
          grep -r "BEGIN OPENSSH PRIVATE KEY\|BEGIN RSA PRIVATE KEY\|BEGIN EC PRIVATE KEY\|sk_live_\|sk_test_\|ghp_\|xoxb-\|xoxp-" --exclude-dir=node_modules --exclude-dir=.git . || echo "No hardcoded secrets found in source code"
          echo "âœ… Secret check completed"

      - name: Generate security report
        run: |
          echo "ðŸ“Š Generating security audit report..."
          echo "# Security Audit Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Findings" >> security-report.md
          echo "- GitGuardian scan completed" >> security-report.md
          echo "- Trivy vulnerability scan completed" >> security-report.md
          echo "- Sensitive files audit completed" >> security-report.md
          echo "- Hardcoded secrets check completed" >> security-report.md
          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "- Review any alerts generated by the scans" >> security-report.md
          echo "- Ensure all secrets are properly managed" >> security-report.md
          echo "- Regular security audits are recommended" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-report.md
