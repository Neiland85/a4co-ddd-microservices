name: ğŸš€ A4CO Monorepo CI/CD (Node 22 + Prisma + Turbo + Docker)

on:
  # Temporarily disabled - use workflow_call only for manual triggers
  workflow_call:
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]
  # workflow_dispatch:

env:
  NODE_ENV: production
  PNPM_HOME: ~/.local/share/pnpm
  PRISMA_ENGINES_CHECK_TIMEOUT: 60000

jobs:
  prisma-verify:
    name: ğŸ” Prisma Auto Verify
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.14.0

      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies (monorepo)
        run: pnpm install --frozen-lockfile

      - name: âš¡ Regenerate Prisma Clients (Fast Mode)
        run: |
          echo "âš¡ Regenerando todos los Prisma Clients detectados en apps/* y services/*"
          pnpm run fix:prisma:fast

      - name: ğŸ§  Prisma Integrity Check
        run: pnpm run check:prisma

      - name: âœ… Prisma Validation Summary
        run: echo "âœ… Prisma Clients regenerados y verificados correctamente para Node 22 + Prisma 6.18.0"

  build-and-test:
    name: ğŸ§ª Build & Test Monorepo
    runs-on: ubuntu-latest
    needs: prisma-verify

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.14.0

      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§® Type Check
        run: pnpm run type-check

      - name: ğŸ—ï¸ Build all packages
        run: pnpm run build

      - name: ğŸ§ª Run tests
        run: pnpm run test --if-present

      - name: âœ… Summary
        run: echo "âœ… Monorepo compilado y testeado correctamente"

  docker-deploy:
    name: ğŸ³ Docker Build & Deploy
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and Push Multi-stage Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./Dockerfile
          tags: |
            ghcr.io/neiland85/a4co-ddd-microservices:latest
            ghcr.io/neiland85/a4co-ddd-microservices:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/neiland85/a4co-ddd-microservices:cache
          cache-to: type=registry,ref=ghcr.io/neiland85/a4co-ddd-microservices:cache,mode=max

      - name: âœ… Deploy summary
        run: echo "ğŸš€ Imagen Docker compilada y subida a GHCR correctamente para commit ${{ github.sha }}"

