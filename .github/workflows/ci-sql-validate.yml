name: Validate SQL scripts (PostgreSQL)

# Validates scripts/init-db.sql by running it against a disposable Postgres DB.
# Triggers on PRs and can be called manually via workflow_call.
#
# Optional repository secrets used by this workflow:
# - CI_POSTGRES_PASSWORD: password for disposable CI postgres (defaults to 'postgres')
# - APP_DB_PASSWORD: password for the application user created during the test run
#
# Note: These secrets are for CI testing only. Production credentials must be managed
# separately and should never be stored in repository files.
on:
  workflow_call: {}
  pull_request:
    paths:
      - 'scripts/**'
  push:
    branches:
      - develop

jobs:
  validate-sql:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: a4co_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval=1s --health-timeout=5s --health-retries=30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready..."
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 && break || sleep 1
          done

      - name: Install psql client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Ensure envsubst available (gettext-base)
        run: |
          if command -v envsubst >/dev/null 2>&1; then
            echo "envsubst already available"
          else
            sudo apt-get update -y
            sudo apt-get install -y gettext-base
          fi

      - name: Preprocess and run init-db.sql against disposable Postgres
        env:
          PGPASSWORD: ${{ secrets.CI_POSTGRES_PASSWORD }}
          APP_DB_PASSWORD: ${{ secrets.APP_DB_PASSWORD || 'secure_ci_test_password' }}
        run: |
          echo "Preprocessing scripts/init-db.sql with envsubst..."
          set -euo pipefail
          # Expand variables into a temporary processed SQL file
          envsubst < scripts/init-db.sql > /tmp/init-db-processed.sql
          echo "Processed SQL preview (first 80 chars):"
          head -c 80 /tmp/init-db-processed.sql || true
          echo "Running processed SQL against local Postgres (a4co_platform)..."
          psql -h localhost -U postgres -d a4co_platform -f /tmp/init-db-processed.sql

      - name: Upload processed SQL artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-sql-script
          path: /tmp/init-db-processed.sql
          retention-days: 7

      - name: Validate SQL security best practices (warnings)
        run: |
          echo "Running SQL security validation script against source and processed SQL..."
          chmod +x ./scripts/validate-sql-security.sh || true
          echo "Checking original script: scripts/init-db.sql"
          ./scripts/validate-sql-security.sh scripts/init-db.sql || true
          echo "Checking processed script: /tmp/init-db-processed.sql"
          ./scripts/validate-sql-security.sh /tmp/init-db-processed.sql || true

      - name: Verify no unexpanded variables remain
        run: |
          if grep -qE '\$\{[A-Z_]+\}' /tmp/init-db-processed.sql; then
            echo "::error file=/tmp/init-db-processed.sql::Unexpanded variables found in processed SQL"
            exit 1
          else
            echo "No unexpanded variables found in processed SQL"
          fi

      - name: Test idempotency (run processed SQL twice)
        env:
          PGPASSWORD: ${{ secrets.CI_POSTGRES_PASSWORD || 'postgres' }}
        run: |
          echo "Running processed SQL twice to verify idempotency..."
          set -euo pipefail
          psql -h localhost -U postgres -d a4co_platform -f /tmp/init-db-processed.sql
          psql -h localhost -U postgres -d a4co_platform -f /tmp/init-db-processed.sql


      - name: Success notice
        run: echo "scripts/init-db.sql executed successfully against disposable Postgres."
