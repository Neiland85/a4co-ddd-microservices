{{- if .Values.externalSecrets.enabled }}
---
# SecretStore - AWS Secrets Manager integration
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "a4co.fullname" . }}-secret-store
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  provider:
    aws:
      service: {{ .Values.externalSecrets.provider.aws.service }}
      region: {{ .Values.externalSecrets.provider.aws.region }}
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# ServiceAccount for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::{{ .Values.externalSecrets.provider.aws.accountId | default "ACCOUNT_ID" }}:role/a4co-external-secrets-role

---
# External Secret: JWT Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-jwt-secret
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-jwt-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        JWT_SECRET: "{{ `{{ .jwt_secret }}` }}"
        JWT_EXPIRATION: "{{ `{{ .jwt_expiration | default "3600" }}` }}"
  data:
  - secretKey: jwt_secret
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/jwt
      property: secret
  - secretKey: jwt_expiration
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/jwt
      property: expiration

---
# External Secret: Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-db-credentials
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-db-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        POSTGRES_USER: "{{ `{{ .username }}` }}"
        POSTGRES_PASSWORD: "{{ `{{ .password }}` }}"
        password: "{{ `{{ .password }}` }}"
        postgres-password: "{{ `{{ .admin_password }}` }}"
        DATABASE_URL: "postgresql://{{ `{{ .username }}` }}:{{ `{{ .password }}` }}@{{ .Values.global.database.host }}:{{ .Values.global.database.port }}/{{ .Values.global.database.name }}?sslmode={{ if .Values.global.database.ssl }}require{{ else }}disable{{ end }}"
  data:
  - secretKey: username
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/database
      property: username
  - secretKey: password
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/database
      property: password
  - secretKey: admin_password
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/database
      property: admin_password

---
# External Secret: Redis Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-redis-credentials
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-redis-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        password: "{{ `{{ .password }}` }}"
        REDIS_PASSWORD: "{{ `{{ .password }}` }}"
        REDIS_URL: "redis://:{{ `{{ .password }}` }}@{{ .Values.global.redis.host }}:{{ .Values.global.redis.port }}/{{ .Values.global.redis.db }}"
  data:
  - secretKey: password
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/redis
      property: password

---
# External Secret: Stripe Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-stripe-credentials
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-stripe-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        STRIPE_SECRET_KEY: "{{ `{{ .secret_key }}` }}"
        STRIPE_PUBLISHABLE_KEY: "{{ `{{ .publishable_key }}` }}"
        STRIPE_WEBHOOK_SECRET: "{{ `{{ .webhook_secret }}` }}"
  data:
  - secretKey: secret_key
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/stripe
      property: secret_key
  - secretKey: publishable_key
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/stripe
      property: publishable_key
  - secretKey: webhook_secret
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/stripe
      property: webhook_secret

---
# External Secret: OAuth Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-oauth-credentials
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-oauth-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        GOOGLE_CLIENT_ID: "{{ `{{ .google_client_id }}` }}"
        GOOGLE_CLIENT_SECRET: "{{ `{{ .google_client_secret }}` }}"
        GITHUB_CLIENT_ID: "{{ `{{ .github_client_id }}` }}"
        GITHUB_CLIENT_SECRET: "{{ `{{ .github_client_secret }}` }}"
  data:
  - secretKey: google_client_id
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/oauth
      property: google_client_id
  - secretKey: google_client_secret
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/oauth
      property: google_client_secret
  - secretKey: github_client_id
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/oauth
      property: github_client_id
  - secretKey: github_client_secret
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/oauth
      property: github_client_secret

---
# External Secret: NATS Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: a4co-nats-credentials
  labels:
    {{- include "a4co.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ include "a4co.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: a4co-nats-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        NATS_USER: "{{ `{{ .username }}` }}"
        NATS_PASSWORD: "{{ `{{ .password }}` }}"
  data:
  - secretKey: username
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/nats
      property: username
  - secretKey: password
    remoteRef:
      key: a4co/{{ .Values.global.environment }}/nats
      property: password

{{- end }}
