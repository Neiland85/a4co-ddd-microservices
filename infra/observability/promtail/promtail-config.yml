# ================================================================
# Promtail Configuration for A4CO Microservices
# PR4: Observability Infrastructure
# ================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Promtail positions file (tracks which logs have been read)
positions:
  filename: /tmp/positions.yaml

# Loki client configuration
clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    external_labels:
      cluster: 'a4co-prod'
      environment: '${ENVIRONMENT:-development}'

# Scrape configurations
scrape_configs:
  # ================================================================
  # DOCKER CONTAINER LOGS
  # ================================================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["logging=promtail"]
    relabel_configs:
      # Container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      
      # Container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'
      
      # Docker image name
      - source_labels: ['__meta_docker_container_image']
        target_label: 'image'
      
      # Docker container labels
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'
      
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'project'
      
      # Log path
      - source_labels: ['__meta_docker_container_id']
        target_label: '__path__'
        replacement: '/var/lib/docker/containers/$1/*.log'
    
    # Pipeline stages for Docker logs
    pipeline_stages:
      # Parse Docker JSON format
      - docker: {}
      
      # Extract JSON fields from log message
      - json:
          expressions:
            level: level
            msg: msg
            service: service
            timestamp: timestamp
            trace_id: trace_id
            span_id: span_id
      
      # Parse timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - RFC3339
            - "2006-01-02T15:04:05.999999999Z07:00"
      
      # Set log level label
      - labels:
          level:
          service:
          trace_id:
          span_id:
      
      # Drop healthcheck logs
      - match:
          selector: '{container=~".*"} |~ "GET /health"'
          action: drop
      
      # Drop Prometheus scrape logs
      - match:
          selector: '{container=~".*"} |~ "GET /metrics"'
          action: drop

  # ================================================================
  # MICROSERVICES LOGS (Alternative file-based)
  # ================================================================
  - job_name: microservices-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: microservices
          __path__: /var/log/microservices/*.log
    
    pipeline_stages:
      # Parse JSON structured logs
      - json:
          expressions:
            level: level
            service: service
            message: message
            timestamp: timestamp
            context: context
            trace_id: trace_id
            span_id: span_id
            event_type: event_type
            aggregate_id: aggregate_id
            correlation_id: correlation_id
      
      # Parse timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # Extract additional labels
      - labels:
          level:
          service:
          event_type:
      
      # Add static labels
      - static_labels:
          source: microservices

  # ================================================================
  # NATS LOGS
  # ================================================================
  - job_name: nats-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: nats
          service: nats-server
          __path__: /var/log/nats/*.log
    
    pipeline_stages:
      # Parse NATS log format
      - regex:
          expression: '^\[(?P<pid>\d+)\] (?P<timestamp>[\d\/]{10} [\d:]{8}) \[(?P<level>\w+)\] (?P<message>.*)'
      
      # Parse timestamp
      - timestamp:
          source: timestamp
          format: "2006/01/02 15:04:05"
      
      # Set labels
      - labels:
          level:
          pid:

  # ================================================================
  # APPLICATION ERROR LOGS
  # ================================================================
  - job_name: application-errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: errors
          __path__: /var/log/microservices/*error*.log
    
    pipeline_stages:
      - json:
          expressions:
            level: level
            service: service
            error: error
            stack: stack
            timestamp: timestamp
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - labels:
          level:
          service:
      
      # Mark as error
      - static_labels:
          severity: error

  # ================================================================
  # SYSTEM LOGS (Optional)
  # ================================================================
  - job_name: syslog
    syslog:
      listen_address: 0.0.0.0:1514
      idle_timeout: 60s
      label_structured_data: yes
      labels:
        job: syslog
    
    relabel_configs:
      - source_labels: ['__syslog_message_hostname']
        target_label: 'host'
    
    pipeline_stages:
      - json:
          expressions:
            message: message
      
      - labels:
          message:

  # ================================================================
  # SAGA ORCHESTRATION LOGS
  # ================================================================
  - job_name: saga-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: saga
          __path__: /var/log/microservices/*saga*.log
    
    pipeline_stages:
      - json:
          expressions:
            level: level
            service: service
            saga_id: saga_id
            saga_type: saga_type
            saga_step: saga_step
            saga_state: saga_state
            timestamp: timestamp
            message: message
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - labels:
          level:
          service:
          saga_type:
          saga_state:
      
      - static_labels:
          source: saga-orchestrator

# Limits configuration
limits_config:
  readline_rate: 10000
  readline_burst: 20000
  readline_rate_enabled: true

# Target configuration
target_config:
  sync_period: 10s
