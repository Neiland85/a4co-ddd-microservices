export interface GeolocationResult {
  lat: number
  lng: number
  accuracy: number
  address?: string
}

export class GeolocationService {
  static async getCurrentPosition(): Promise<GeolocationResult> {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation is not supported by this browser"))
        return
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy,
          })
        },
        (error) => {
          let message = "Unable to retrieve your location"

          switch (error.code) {
            case error.PERMISSION_DENIED:
              message = "Location access denied by user"
              break
            case error.POSITION_UNAVAILABLE:
              message = "Location information is unavailable"
              break
            case error.TIMEOUT:
              message = "Location request timed out"
              break
          }

          reject(new Error(message))
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000, // 5 minutes
        },
      )
    })
  }

  static async reverseGeocode(lat: number, lng: number): Promise<string> {
    try {
      // Using Nominatim for reverse geocoding (free alternative)
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
        {
          headers: {
            "User-Agent": "A4CO-Map-App",
          },
        },
      )

      if (!response.ok) {
        throw new Error("Reverse geocoding failed")
      }

      const data = await response.json()
      return data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`
    } catch (error) {
      console.warn("Reverse geocoding failed:", error)
      return `${lat.toFixed(4)}, ${lng.toFixed(4)}`
    }
  }
}
